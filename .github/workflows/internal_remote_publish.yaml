name: Internal remote workflow

permissions:
  contents: write

on:
  push:
    branches:
      - dev-remote

concurrency:
  group: publish-dev-remote
  cancel-in-progress: false

jobs:
  check-branch:
    runs-on: ubuntu-latest
    outputs:
      should_publish: ${{ steps.msgcheck.outputs.should_publish }}
    steps:
      - name: Ensure workflow is run from dev-remote branch
        run: |
          if [[ "${GITHUB_REF_NAME}" != "dev-remote" ]]; then
            echo "This workflow can only be run from the dev-remote branch."
            exit 1
          fi

      - name: Check if commit was generated by SDK step
        id: msgcheck
        run: |
          msg="${{ github.event.head_commit.message || '' }}"
          echo "Head commit message: $msg"
          if [[ "$msg" == *"chore(sdk): generate prerelease"* ]]; then
            echo "should_publish=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_publish=false" >> "$GITHUB_OUTPUT"
          fi

  publish:
    needs: check-branch
    if: needs.check-branch.outputs.should_publish == 'true'
    uses: speakeasy-api/sdk-generation-action/.github/workflows/sdk-publish.yaml@57452fc95969792de6734a91400a24aeb409964c
    with:
      target: cribl-control-plane
    secrets:
      github_access_token: ${{ secrets.GITHUB_TOKEN }}
      npm_token: ${{ secrets.NPM_TOKEN }}
      speakeasy_api_key: ${{ secrets.SPEAKEASY_API_KEY }}
